# JWT auth with Go
## Запуск
Для запуска потребуется любой MongoDB контейнер на портах 27017:27017

Например: ```docker run --name some-mongo -p 27017:27017 -d mongo```

После этого запускаем наш сервис: ```.\JWTauth.exe```

## Эндпоинты
**[POST]** 	```localhost:8080/login?guid={ваше_guid}``` - получить пару _access/refresh_ токенов для пользователя с заданным ID (GUID)

**[POST]** 	```localhost:8080/refresh``` - обновить пару _access/refresh_ токенов с помощью _refresh_-токена, хранящимся в кукис

## Алгоритм работы
### Получение пары токенов (логин)
Из параметров запроса извлекается GUID пользователя. 
На основе GUID (который записывается в payload) создается _access_ токен (JWT, метод HS512, основанный на SHA512). 
Время жизни (также записанное в payload) _access_ токена - 5 минут. Токен подписывается выбранной сигнатурой (моим именем).

Вместе с ним генерируется _refresh_ токен, представляющий собой uuid. Время жизни _refresh_ токена - 24 часа.
В базу данных сохраняется запись о сессии пользователя, где есть _refresh_ токен (хешированный bcrypt перед сохранением,
соль случайна), время жизни _refresh_ токена и ID пользователя.
Если сессия для текущего пользователя уже существует, то "старая" сессия удаляется из базы.

Оба токена передаются в качестве кукис, при этом _refresh_ токен перед передачей кодируется алгоритмом base64.

### Обновление токенов (рефреш)
Из кукис пытаемся получить _refresh_ токен. Если его нет (или истек, тогда его тоже не будет), 
тогда сервер возвращает статус 401.

Если токен получаем, тогда декодируем его обратно из base64. Начинаем поиск токена в базе данных сессий.
Из-за случайности соли, заново хешировать и сразу найти нужный мы не можем, поэтому будем сверять наш токен с каждым
захешированным токеном из базы данных.

После нахождения нужной сессии по полю с _refresh_ токеном (если такого токена нет, то сервер возвращает статус 500), 
мы получаем GUID пользователя в этой сессии и удаляем найденную сессию (т.к. она уже считается "старой").
По найденному айдишнику заново генерируем оба токена аналогично алгоритму выше.

### Основные источники
* [Про JWT токены и алгоритмы работы с ними в целом](https://gist.github.com/zmts/802dc9c3510d79fd40f9dc38a12bccfc?permalink_comment_id=4195129)
* [Пример простейшей работы с JWT токенами (без refresh'a) в Go (да, слушать тяжело)](https://www.youtube.com/watch?v=hWmR8YtlFlE&t=1588s&ab_channel=DailyCodeBuffer)
* [Работа с MongoDB в Go](https://www.mongodb.com/docs/drivers/go/current/usage-examples/)